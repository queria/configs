#!/bin/bash

generator="$(readlink -f $1)"
src="$(mktemp)"
tgt="$2"

trap "rm -f $src" EXIT

if [[ -L "$tgt" ]]; then
    # backward compat - for changing from symlink to bash generated config
    echo "Converting ‘$tgt’ from symlink to generated"
    touch "$CHANGED"
    $SUDO rm -vf "$tgt"
fi

$generator > "$src"

if diff "$src" "$tgt" &> /dev/null; then
    echo -e "${CLR_ALREADY}‘$tgt’ generated [already]${CLR_NONE}";
    # content already matches
    exit
else
    [[ -f "$tgt" ]] && bup "$tgt"
    $SUDO mv "$src" "$tgt"
    echo "‘$tgt’ generated by $generator";
    touch "$CHANGED"
fi
